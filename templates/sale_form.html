{% extends "base.html" %}
{% block title %}Ventas{% endblock %}
{% block content %}
<!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}"> -->

<header class="app-header">
  <div class="container">
    <div class="header-inner">
      <h1 class="brand" style="margin: 0;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
          <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        Sistema de Ventas
      </h1>
      <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
        <div class="role-badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
          </svg>
          <span id="currentTime" style="margin-left: 6px;"></span>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 32px;">
    <div class="card" style="padding: 0; overflow: hidden;">
      <div style="background: linear-gradient(135deg, var(--brand), var(--brand-2)); padding: 16px 20px; color: white; display: flex; align-items: center; gap: 10px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <strong style="font-size: 1rem;">Escanear / Buscar Productos</strong>
      </div>
      <div style="padding: 20px;">
        <div style="position: relative; margin-bottom: 16px;">
          <input type="text" autofocus class="search-input" id="search" 
                 placeholder="Código de barras o nombre del producto..."
                 style="width: 100%; padding: 12px 16px; padding-left: 44px; border-radius: var(--radius-md); border: 2px solid var(--border); background: var(--panel-2); color: var(--text); font-size: 1rem; outline: none; transition: border-color .15s ease, box-shadow .15s ease;">
          <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.5;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2m0 10v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <div id="suggestions" class="hidden" style="position: absolute; width: 100%; z-index: 1000; max-height: 320px; overflow-y: auto; margin-top: 8px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow-lg);"></div>
        </div>
        
        <div style="padding: 14px; border-radius: var(--radius-md); background: color-mix(in srgb, var(--brand) 8%, transparent); border-left: 3px solid var(--brand); margin-bottom: 16px;">
          <div style="display: flex; gap: 10px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px; color: var(--brand);">
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <div style="font-size: 0.88rem; line-height: 1.5;">
              <strong>Uso rápido:</strong> Escanea o escribe y presiona Enter. Repite el código para incrementar cantidad.<br>
              <strong>Formatos:</strong> CODIGO*3 / CODIGO x3 / CODIGO-3
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <span class="badge" style="padding: 6px 12px; background: var(--panel-2);">
            <kbd style="padding: 2px 6px; background: var(--bg); border-radius: 4px; font-size: 0.75rem; font-family: monospace;">F2</kbd> Enfocar búsqueda
          </span>
          <span class="badge" style="padding: 6px 12px; background: var(--panel-2);">
            <kbd style="padding: 2px 6px; background: var(--bg); border-radius: 4px; font-size: 0.75rem; font-family: monospace;">Ctrl</kbd> + 
            <kbd style="padding: 2px 6px; background: var(--bg); border-radius: 4px; font-size: 0.75rem; font-family: monospace;">⌫</kbd> Vaciar carrito
          </span>
        </div>
      </div>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
      <div style="background: linear-gradient(135deg, var(--success), #059669); padding: 16px 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <strong style="font-size: 1rem;">Carrito de Compra</strong>
          <span id="cartCount" class="badge" style="background: white; color: var(--success); padding: 4px 10px; font-weight: 700;">0</span>
        </div>
        <button class="btn-ghost" id="clearCart" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; padding: 6px 12px; font-size: 0.85rem;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          Vaciar
        </button>
      </div>
      <div style="max-height: 420px; overflow-y: auto; min-height: 280px;">
        <table style="width: 100%; border-collapse: collapse;" id="cartTable">
          <thead style="position: sticky; top: 0; background: var(--panel-2); z-index: 10;">
            <tr style="border-bottom: 1px solid var(--border);">
              <th style="padding: 14px 16px; text-align: left; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Producto</th>
              <th style="padding: 14px 16px; text-align: center; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Cant.</th>
              <th style="padding: 14px 16px; text-align: right; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Precio</th>
              <th style="padding: 14px 16px; text-align: right; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Subtotal</th>
              <th style="padding: 14px 16px; text-align: center; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Acción</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="emptyCart" style="text-align: center; padding: 60px 20px;">
          <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); opacity: 0.4; margin-bottom: 16px;">
            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <p style="color: var(--text-muted); margin: 0 0 6px 0;">El carrito está vacío</p>
          <p style="color: var(--text-muted); font-size: 0.88rem; margin: 0;">Escanea productos para comenzar</p>
        </div>
      </div>
      <div style="padding: 20px; border-top: 1px solid var(--border); background: var(--panel-2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h5 style="margin: 0; font-size: 1.1rem; font-weight: 700;">TOTAL</h5>
          <h4 style="margin: 0; font-size: 1.6rem; font-weight: 700; color: var(--success);">$<span id="cartGrand">0.00</span></h4>
        </div>
        <button id="confirmSale" class="btn" style="width: 100%; padding: 14px; font-size: 1rem;" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Confirmar Venta
        </button>
      </div>
    </div>
  </div>

  <div class="hr" style="margin: 40px 0;"></div>

  <div class="card" style="padding: 0; overflow: hidden;">
    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
      <h5 style="margin: 0; font-size: 1.1rem; font-weight: 700;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        Historial de Ventas
      </h5>
      
      <form id="filterForm" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
        <div class="field">
          <label class="label" style="font-size: 0.82rem; margin-bottom: 4px;">Desde</label>
          <input type="date" name="from" id="from" style="padding: 8px 12px; font-size: 0.9rem;">
        </div>
        <div class="field">
          <label class="label" style="font-size: 0.82rem; margin-bottom: 4px;">Hasta</label>
          <input type="date" name="to" id="to" style="padding: 8px 12px; font-size: 0.9rem;">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="submit" class="btn-ghost" style="padding: 8px 14px; font-size: 0.9rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            Filtrar
          </button>
          <button type="button" id="clearFilter" class="btn-ghost" style="padding: 8px 14px; font-size: 0.9rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Limpiar
          </button>
        </div>
      </form>
    </div>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;" id="salesTable">
        <thead style="background: var(--panel-2);">
          <tr style="border-bottom: 1px solid var(--border);">
            <th style="padding: 14px 16px; text-align: left; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">ID</th>
            <th style="padding: 14px 16px; text-align: left; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Fecha y Hora</th>
            <th style="padding: 14px 16px; text-align: left; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Productos</th>
            <th style="padding: 14px 16px; text-align: right; font-size: 0.88rem; color: var(--text-muted); font-weight: 600;">Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="emptyMsg" class="hidden" style="text-align: center; padding: 60px 20px;">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); opacity: 0.4; margin-bottom: 16px;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--text-muted); margin: 0 0 6px 0;">No hay ventas registradas</p>
        <p style="color: var(--text-muted); font-size: 0.88rem; margin: 0;">Las ventas aparecerán aquí una vez registradas</p>
      </div>
    </div>
    
    <div style="padding: 20px; border-top: 1px solid var(--border); background: var(--panel-2);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600; font-size: 1rem;">Total del Período</span>
        <h5 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--brand);">$<span id="grandTotal">0.00</span></h5>
      </div>
    </div>
  </div>
</main>

<style>
.search-input:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 18%, transparent);
}

#suggestions .suggestion-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .12s ease, border-left .12s ease;
  border-left: 3px solid transparent;
}

#suggestions .suggestion-item:hover {
  background: var(--panel-2);
  border-left-color: var(--brand);
}

#suggestions .suggestion-item:last-child {
  border-bottom: none;
}

#cartTable tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background .12s ease;
}

#cartTable tbody tr:hover {
  background: var(--panel-2);
}

#cartTable tbody tr td {
  padding: 14px 16px;
}

.qty-input {
  width: 70px;
  text-align: center;
  padding: 6px 8px;
  font-size: 0.9rem;
}

#confirmSale:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  filter: grayscale(0.3);
}

#salesTable tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background .12s ease;
}

#salesTable tbody tr:hover {
  background: var(--panel-2);
}

#salesTable tbody tr td {
  padding: 14px 16px;
}

@media (min-width: 900px) {
  main.container > div:first-child {
    grid-template-columns: 1fr 1fr;
  }
}

.toast {
  position: fixed;
  right: 20px;
  bottom: 20px;
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-left: 4px solid var(--success);
  padding: 14px 18px;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 100;
  max-width: 360px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.toast.error {
  border-left-color: var(--danger);
}
</style>
{% endblock %}

{% block scripts %}
<script>
const cart = new Map();
let searchTimer;

function showNotification(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast' + (type === 'error' ? ' error' : '');
  toast.innerHTML = `
    <div style="display:flex; align-items:center; gap:10px;">
      <strong>${type === 'error' ? 'Error' : 'OK'}</strong>
      <span>${message}</span>
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function updateClock() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

async function searchItems(term) {
  if (!term) return [];
  const res = await fetch('/api/items?q=' + encodeURIComponent(term));
  return res.ok ? res.json() : [];
}

function parseTerm(raw) {
  const t = raw.trim();
  const m = t.match(/^(.*?)(?:[*xX\-]\s*(\d+))$/);
  if (m) {
    return { code: m[1].trim(), qty: parseInt(m[2],10) };
  }
  return { code: t, qty: 1 };
}

function renderSuggestions(items) {
  const box = document.getElementById('suggestions');
  box.innerHTML = '';
  if (!items.length) { 
    box.classList.add('hidden'); 
    return; 
  }
  box.classList.remove('hidden');
  items.slice(0,8).forEach(it => {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    const stockBadge = it.stock > 0 
      ? `<span class="badge success" style="background: color-mix(in srgb, var(--success) 15%, transparent); color: var(--success); padding: 4px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">${it.stock} en stock</span>`
      : `<span class="badge danger" style="background: color-mix(in srgb, var(--danger) 15%, transparent); color: var(--danger); padding: 4px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">Sin stock</span>`;
    div.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
        <span style="font-weight: 600;">${it.name}</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          ${stockBadge}
          <span style="color: var(--text-muted); font-weight: 600;">$${it.price.toFixed(2)}</span>
        </div>
      </div>
    `;
    div.addEventListener('click', () => {
      addToCart(it, 1);
      hideSuggestions();
      focusSearch();
    });
    box.appendChild(div);
  });
}

function hideSuggestions() {
  document.getElementById('suggestions').classList.add('hidden');
}

function addToCart(item, qty=1) {
  const existing = cart.get(item.id);
  const newQty = existing ? existing.quantity + qty : qty;
  cart.set(item.id, {
    id: item.id,
    name: item.name,
    unit_price: item.price,
    quantity: newQty
  });
  renderCart();
}

function renderCart() {
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';
  let total = 0;
  let itemCount = 0;
  
  if (!cart.size) {
    document.getElementById('emptyCart').style.display = 'block';
    document.getElementById('confirmSale').disabled = true;
    document.querySelector('#cartTable').style.display = 'none';
  } else {
    document.getElementById('emptyCart').style.display = 'none';
    document.getElementById('confirmSale').disabled = false;
    document.querySelector('#cartTable').style.display = 'table';
  }
  
  cart.forEach(row => {
    const lineTotal = row.quantity * row.unit_price;
    total += lineTotal;
    itemCount += row.quantity;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight: 600;">${row.name}</td>
      <td style="text-align: center;">
        <input type="number" min="1" value="${row.quantity}" class="qty-input" data-id="${row.id}">
      </td>
      <td style="text-align: right; color: var(--text-muted);">$${row.unit_price.toFixed(2)}</td>
      <td style="text-align: right; font-weight: 700;">$${lineTotal.toFixed(2)}</td>
      <td style="text-align: center;">
        <button class="btn-ghost remove-btn" data-id="${row.id}" style="padding: 6px 10px; background: color-mix(in srgb, var(--danger) 10%, transparent); border-color: color-mix(in srgb, var(--danger) 20%, transparent); color: var(--danger);" title="Eliminar producto">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </td>
    `;
    
    tr.querySelector('.qty-input').addEventListener('change', (e) => {
      const v = parseInt(e.target.value, 10);
      if (v > 0) {
        row.quantity = v;
        renderCart();
      }
    });
    
    tr.querySelector('.remove-btn').addEventListener('click', () => {
      cart.delete(row.id);
      renderCart();
      focusSearch();
    });
    
    tbody.appendChild(tr);
  });
  
  document.getElementById('cartCount').textContent = itemCount;
  document.getElementById('cartGrand').textContent = total.toFixed(2);
}

function focusSearch() {
  const s = document.getElementById('search');
  s.focus();
  s.select();
}

document.getElementById('search').addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const raw = e.target.value;
    if (!raw.trim()) return;
    const { code, qty } = parseTerm(raw);
    const results = await searchItems(code);
    if (!results.length) {
      e.target.value = '';
      hideSuggestions();
      return;
    }
    const exact = results.find(r => r.barrs_code === code);
    if (exact) {
      addToCart(exact, qty);
      e.target.value = '';
      hideSuggestions();
      return;
    }
    if (results.length === 1) {
      addToCart(results[0], qty);
      e.target.value = '';
      hideSuggestions();
      return;
    }
    const sugBox = document.getElementById('suggestions');
    if (!sugBox.classList.contains('hidden')) {
      const first = results[0];
      addToCart(first, qty);
      e.target.value = '';
      hideSuggestions();
    } else {
      renderSuggestions(results);
    }
  }
});

document.getElementById('search').addEventListener('input', (e) => {
  clearTimeout(searchTimer);
  const val = e.target.value.trim();
  if (!val) { hideSuggestions(); return; }
  searchTimer = setTimeout(async () => {
    const { code } = parseTerm(val);
    renderSuggestions(await searchItems(code));
  }, 180);
});

document.getElementById('clearCart').addEventListener('click', () => {
  if (cart.size && confirm('¿Estás seguro de vaciar el carrito?')) {
    cart.clear();
    renderCart();
    focusSearch();
  }
});

document.getElementById('confirmSale').addEventListener('click', async () => {
  if (!cart.size) return;
  const btn = document.getElementById('confirmSale');
  btn.disabled = true;
  btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;"><circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10"/></svg>Procesando...';
  
  const payload = Array.from(cart.values()).map(r => ({ item_id: r.id, quantity: r.quantity }));
  const res = await fetch('/api/sales/bulk', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json'},
    body: JSON.stringify({ items: payload })
  });
  
  console.log(res);
  const data = await res.json();
  console.log(data);

  if (res.ok) {
    cart.clear();
    renderCart();
    renderSales(await fetchSales(currentFilterParams()));
    focusSearch();
    showNotification('Venta registrada exitosamente', 'success');
  } else {
    showNotification('Error al registrar venta', );
  }
  
  btn.disabled = false;
  btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><polyline points="20 6 9 17 4 12"/></svg>Confirmar Venta';
});

async function fetchSales(params = {}) {
  const qs = new URLSearchParams(params).toString();
  const res = await fetch('/api/sales' + (qs ? '?' + qs : ''));
  return res.ok ? res.json() : [];
}

function renderSales(data) {
  console.log(data);
  const tbody = document.querySelector('#salesTable tbody');
  tbody.innerHTML = '';
  let totalPeriod = 0;
  
  if (!data.length) {
    document.getElementById('emptyMsg').classList.remove('hidden');
  } else {
    document.getElementById('emptyMsg').classList.add('hidden');
  }
  
  data.forEach(s => {
    totalPeriod += (s.total || 0);
    const tr = document.createElement('tr');
    const itemsList = (s.items || []).map(i => `${i.product_name} <span class="badge" style="background: var(--panel-2); padding: 4px 8px; border-radius: 999px; font-size: 0.75rem;">x${i.quantity}</span>`).join(', ');
    tr.innerHTML = `
      <td><span class="badge" style="background: color-mix(in srgb, var(--brand) 15%, transparent); color: var(--brand); padding: 4px 10px; border-radius: 999px; font-weight: 600;">#${s.id}</span></td>
      <td style="color: var(--text-muted);">${s.date || ''}</td>
      <td>${itemsList}</td>
      <td style="text-align: right; font-weight: 700; color: var(--success);">$${(s.total || 0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('grandTotal').textContent = totalPeriod.toFixed(2);
}

function currentFilterParams() {
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  const p = {};
  if (from) p.from = from;
  if (to) p.to = to;
  return p;
}

document.getElementById('filterForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  renderSales(await fetchSales(currentFilterParams()));
});

document.getElementById('clearFilter').addEventListener('click', async () => {
  document.getElementById('from').value = '';
  document.getElementById('to').value = '';
  renderSales(await fetchSales());
  focusSearch();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#search') && !e.target.closest('#suggestions')) {
    hideSuggestions();
  }
});

fetchSales().then(renderSales);
focusSearch();
</script>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
{% endblock %}
